---
title: "SurvivalAnalysis"
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

```{r}
# Install necessary packages
install.packages("epiR")
install.packages("epiDisplay")
install.packages("survival")
install.packages("cmprsk")
install.packages("tidyverse")

# Load the packages
library(epiR)
library(epiDisplay)
library(survival)
library(cmprsk)
library(tidyverse)


getwd()
read_lines("toxo.txt")
toxo <- read.table(file="toxo.txt", header = TRUE, sep="\t", na.string="NA", dec=".")

head(toxo)
tail(toxo)
str(toxo)
dim(toxo)

#Age
epi.descriptives(toxo$AGE[toxo$PYRPLA==0])$a
epi.descriptives(toxo$AGE[toxo$PYRPLA==1])$a
var.test(toxo$AGE~toxo$PYRPLA)
t.test(toxo$AGE~toxo$PYRPLA, var.equal=T)

#CD4
toxo$CD4 <- as.numeric(toxo$CD4)
epi.descriptives(toxo$CD4[toxo$PYRPLA==0])$a
epi.descriptives(toxo$CD4[toxo$PYRPLA==1])$a
var.test(toxo$CD4~toxo$PYRPLA)
t.test(toxo$CD4~toxo$PYRPLA, var.equal=F)

#HEMOG
epi.descriptives(toxo$HEMOG[toxo$PYRPLA==0])$a
epi.descriptives(toxo$HEMOG[toxo$PYRPLA==1])$a
var.test(toxo$HEMOG~toxo$PYRPLA)
t.test(toxo$HEMOG~toxo$PYRPLA, var.equal=T)

#SEXE
tabpct(toxo$SEXE, toxo$PYRPLA, percent = "col")
chisq.test(toxo$SEXE, toxo$PYRPLA)$expected
chisq.test(toxo$SEXE, toxo$PYRPLA, correct = F)
fisher.test(toxo$SEXE, toxo$PYRPLA)

#HIV status
tabpct(toxo$STADE, toxo$PYRPLA, percent = "col")
chisq.test(toxo$STADE, toxo$PYRPLA)$expected
chisq.test(toxo$STADE, toxo$PYRPLA, correct = F)
fisher.test(toxo$STADE, toxo$PYRPLA)

toxo %>%
  group_by(PYRPLA) %>%
  summarise(
    mean_age = mean(AGE, na.rm = TRUE),
    sd_age = sd(STADE, na.rm = TRUE),
    mean_time = mean(SEXE, na.rm = TRUE),
  )

# Display proportions for each group
tabpct(INDDECES ~ PYRPLA, data = data)

# Summarize by treatment group
summary_table <- aggregate(. ~ PYRPLA, data = toxo, FUN = summary)
print(summary_table)


```

```{r}
install.packages("tableone")
library(tableone)

dput(names(toxo))
str(toxo)
var_character <- c("NUMINC")
var_numeric <- c("AGE", "CD4", "HEMOG", "DELTOXO", "DELDECES", "INDDECES","DELSTATUS")
var_factor <- c("SEXE", "STADE", "PYRPLA", "INDTOXO", "INDDECES", "STATUS")

toxo[, var_character] <- lapply(toxo[, var_character], as.character)
toxo[, var_numeric] <- lapply(toxo[, var_numeric], as.numeric)
toxo[, var_factor] <- lapply(toxo[, var_factor], as.factor)

vars <- c("AGE", "STADE", "SEXE", "CD4", "HEMOG", 
"INDTOXO", "DELTOXO", "INDDECES", "DELDECES", "STATUS", "DELSTATUS")
factorvars <-  c("SEXE", "STADE", "INDTOXO", "INDDECES", "STATUS")
tbl_1 <- CreateTableOne(vars=vars, strata= "PYRPLA", factorvars, includeNA=T, addOverall=F, data=toxo)
tbl_1 %>% print(showAllLevels = F, includeNA = T)
tbl_1 %>% print(showAllLevels = F, includeNA = T, nonnormal = vars) %>% write.csv(file="tableone.csv")

```

```{r}
# Load necessary library
library(survival)

str(toxo)

# Create a survival object, using DELSTATUS (time) and INDDECES (event)
surv_object <- Surv(time = toxo$DELDECES, event = toxo$INDDECES)

# Fit the Kaplan-Meier estimator for each group (PYRPLA is the treatment group)
fit1 <- survfit(surv_object ~ PYRPLA, data = toxo)
summary(fit1)

# Plot the Kaplan-Meier curves
help(survfit)
plot(fit1, col = c("blue", "red"), mark.time=F, lty = 1:2, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curves")
legend("bottomleft", legend = c("Placebo", "Pyrimethamine"), col = c("blue", "red"), lty = 1:2)

print(fit1)
```

4\) Estimate the probability of experiencing a 1st episode of toxo in each treatment group: 

a\. Which estimator should be used? Give its formula 

b\. Plot the estimated curves 

c\. What is the estimated probability of experiencing a first episode of toxo in the first year of the trial in each group? 

```{r}
tab1(toxo$STATUS)

fit2 <- cuminc(toxo$DELSTATUS, toxo$STATUS, group=toxo$PYRPLA)
summary(fit2)

# Plot cumulative incidence curves
plot(fit2, wh=c(-1,-1), lty=1:4, cex=1, col = c("blue", "red","blue", "red"))
legend("topleft", legend = c("Placebo --> toxo", "Pyrimethamine --> toxo", "Placebo --> Death wo toxo", "Pyrimethamine --> Death wo toxo"), col = c("blue", "red","blue", "red"), lty = 1:4)

```

```{r}
timepoints(fit2, time=c(365, 730, 999))
```

5\) Estimate the crude association between the treatment group and the hazard of toxo 

a\. Write the equation of the model

b\. Estimate the model, and interpret the results 

c\. Check the proportional hazards (PH) assumption.

```{r}

str(toxo)
toxo$PYRPLA <- as.factor(toxo$PYRPLA)
fit3 <- coxph(Surv(time = toxo$DELTOXO, event = toxo$INDTOXO) ~ PYRPLA, data = toxo)

summary(fit3)

cox.display(fit3)

prop3 <- cox.zph(fit3)
print(prop3)
plot(prop3)
```

```{r}
tab1(toxo$STADE)
fit4 <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + factor(STADE)+ PYRPLA:factor(STADE), data = toxo)
summary(fit4)
```

```{r}
fit4a <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + factor(STADE), data = toxo)
dev4a <- -2 * fit4a$loglik[2] 
fit4b <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + factor(STADE)+ PYRPLA:factor(STADE), data = toxo)
dev4b <- -2 * fit4b$loglik[2] 

dev4a
dev4b
```

```{r}
toxo$STADE3 <- relevel(as.factor(toxo$STADE), ref="3")
fit4c <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + factor(STADE3) + PYRPLA:factor(STADE3), data = toxo)
summary(fit4c)
anova(fit4b, fit4c)
```

```{r}
toxo$STADE4 <- relevel(as.factor(toxo$STADE), ref="4")
fit4d <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + factor(STADE4) + PYRPLA:factor(STADE4), data = toxo)
summary(fit4d)
anova(fit4b, fit4d)
```

```{r}
toxo$STADE5 <- relevel(as.factor(toxo$STADE), ref="5")
fit4e <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + factor(STADE5) + PYRPLA:factor(STADE5), data = toxo)
summary(fit4e)
anova(fit4b, fit4e)
```

7\) Estimate the association between the treatment group and the hazard of toxo, adjusted for age, sex, HIV stage, CD4 and hemoglobin levels at inclusion. 

```{r}
toxo$AGE10 <- toxo$AGE / 10
toxo$CD4100 <- toxo$CD4 / 100
toxo$STADE <- as.factor(toxo$STADE)

fit5 <- coxph(Surv(DELTOXO, INDTOXO) ~ PYRPLA + AGE10 + SEXE + STADE + CD4100 + HEMOG, data = toxo)
summary(fit5)
cox.display(fit5)
```

At any time after randomization, after adjustment for treatment, sex, CD4 count and HEMOG at baseline, the hazard of experiencint toxoplasm decreases by 31% for every 100 increase in CD4 count at baseline . And the result is statistically significant.

Check the linear assumption for each quantitative variable, using a penalized spline function 

```{r}
# toxo$AGE10 <- toxo$AGE / 10
# toxo$CD4100 <- toxo$CD4 / 100
# toxo$STADE <- as.factor(toxo$STADE)
fit6 <- coxph(Surv(DELTOXO, INDTOXO) ~ factor(PYRPLA) + pspline(AGE10, df=4) + factor(SEXE) + factor(STADE) + pspline(CD4100, df=4) + pspline(HEMOG, df=4), data = toxo)
summary(fit6)
```
